<!DOCTYPE HTML>
<html lang='en'>
<head>
    <title>Sext Machine</title>
</head>
<body>
    <input id='image-upload' type="file" accept="image/*" capture="camera" />

    <script>
        document.getElementById("image-upload").onchange = function(){
            var files = document.getElementById("image-upload").files;
            var file = files[0];
            if(file == null){
                alert("No file selected.");
            }
            else{
                getSignedRequest(file);
            }
        };

        function getSignedRequest(file){
            var xhr = new XMLHttpRequest();
            xhr.open("GET", "/sign_s3?fileName="+file.name+"&fileType="+file.type);
            xhr.onreadystatechange = function(){
                if(xhr.readyState === 4){
                    console.log("Getting ready to upload file")
                    if(xhr.status === 200){
                        console.log("Status was 200")
                        var response = JSON.parse(xhr.responseText);
                        uploadFile(file, response.signedRequest, response.url);
                    }
                    else{
                        alert("Could not get signed URL.");
                    }
                }
            };
            xhr.send();
        }

        function uploadFile(file, signedRequest, url){
            console.log("Uploading file")
            console.log(file, signedRequest, url)
            var xhr = new XMLHttpRequest();
            xhr.open("PUT", signedRequest);
            xhr.setRequestHeader('x-amz-acl', 'public-read');
            xhr.onload = function() {
                if (xhr.status === 200) {
                    console.log("Uploaded at " + url);
                }
            };
            xhr.onerror = function() {
                alert("Could not upload file.");
            };
            xhr.send(file);
        }
        </script>
</body>
</html>